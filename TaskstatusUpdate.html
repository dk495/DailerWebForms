<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task ID Submission Update</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://pyscript.net/alpha/pyscript.js"></script>
<link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css">
</head>
<body>
<div class="container">
    <h1>Task ID Submission Update</h1>
    <form id="taskForm">
        <div class="form-group">
            <label for="task_id">Task ID:</label>
            <input type="number" class="form-control" id="task_id" name="task_id" required>
        </div>
        <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
    </form>
    <div id="successAlert"></div>
    <div id="response"></div>
</div>

<py-script>
import js
import asyncio
from pyodide.http import pyfetch

async def submit_form(event):
    event.preventDefault()  # Prevent default form submission
    task_id = js.document.getElementById("task_id").value
    data = {
        "task_id": task_id,
        "status": "done"
    }

    # Disable submit button to prevent multiple submissions
    js.document.getElementById("submitBtn").disabled = True

    try:
        response = await pyfetch(
            url="https://callback.textback.ai/jornaya/task/status",
            method="POST",
            headers={"Content-Type": "application/json"},
            body=str(data)
        )

        if response.status == 200:
            # Show success message
            js.document.getElementById("successAlert").innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert">Status posted successfully</div>'
            # Hide success message after 3 seconds
            js.setTimeout(lambda: js.document.querySelector('.alert').classList.remove('show'), 3000)
            await task_id_submission(task_id)

        js.document.getElementById("submitBtn").disabled = False

    except Exception as e:
        print(f"Error: {e}")
        js.document.getElementById("submitBtn").disabled = False

async def task_id_submission(taskid):
    try:
        await pyfetch(
            url=f"https://pinnacledebtrelief.com/insert_task.php?task_id={taskid}",
            method="GET",
            mode="no-cors"
        )
    except Exception as e:
        print(f"Error: {e}")

# Attach the submit_form function to the form submission event
form = js.document.getElementById("taskForm")
form.addEventListener("submit", submit_form)
</py-script>
</body>
</html>
